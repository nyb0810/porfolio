-- BÀI T?P CHUONG 2

CREATE TABLE KHACHHANG
(
MAKHACHHANG NVARCHAR(10) NOT NULL PRIMARY KEY,
TENCONGTY NVARCHAR(50) NOT NULL,
TENGIAODICH  NVARCHAR(30),
DIACHI NVARCHAR(50),
EMAIL NVARCHAR(30),
DIENTHOAI NVARCHAR(20),
FAX NVARCHAR(20)
)

CREATE TABLE DONDATHANG
(
SOHOADON NVARCHAR(10) NOT NULL PRIMARY KEY,
MAKHACHHANG NVARCHAR(10) NOT NULL,
MANHANVIEN NVARCHAR(10) NOT NULL,
NGAYDATHANG DATE,
NGAYGIAOHANG DATE,
NGAYCHUYENHANG DATE,
NOIGIAOHANG NVARCHAR(50),
FOREIGN KEY (MAKHACHHANG) REFERENCES KHACHHANG(MAKHACHHANG),
FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN(MANHANVIEN)
);

CREATE TABLE NHANVIEN
(
MANHANVIEN NVARCHAR(10) NOT NULL PRIMARY KEY,
HO NVARCHAR(10) ,
TEN NVARCHAR(10),
NGAYSINH DATE,
NGAYLAMVIEC DATE,
DIACHI NVARCHAR(50),
DIENTHOAI NVARCHAR(20),
LUONGCOBAN DECIMAL(9,4),
PHUCAP DECIMAL(9,4)
)

CREATE TABLE NHACUNGCAP
(
MACONGTY NVARCHAR(10) NOT NULL PRIMARY KEY,
TENCONGTY NVARCHAR(50) NOT NULL,
TENGIAODICH  NVARCHAR(30),
DIACHI NVARCHAR(50),
EMAIL NVARCHAR(30),
DIENTHOAI NVARCHAR(20),
FAX NVARCHAR(20)
)

CREATE TABLE CHITIETDATHANG  
(
SOHOADON NVARCHAR(10) NOT NULL,
MAHANG NVARCHAR(10) NOT NULL ,
GIABAN  DECIMAL(9,4),
SOLUONG INT,
MUCGIAMGIA FLOAT
PRIMARY KEY (SOHOADON,MAHANG)
)

CREATE TABLE MATHANG
(
MAHANG NVARCHAR(10) NOT NULL PRIMARY KEY,
TENHANG NVARCHAR(50) ,
MACONGTY  NVARCHAR(10) NOT NULL,
MALOAIHANG NVARCHAR(10) NOT NULL,
SOLUONG INT,
DONVITINH NVARCHAR(15),
GIAHANG DECIMAL(9,4),
FOREIGN KEY (MACONGTY) REFERENCES NHACUNGCAP(MACONGTY),
FOREIGN KEY (MALOAIHANG) REFERENCES LOAIHANG(MALOAIHANG)
)

CREATE TABLE LOAIHANG
(
MALOAIHANG NVARCHAR(10) NOT NULL PRIMARY KEY,
TENLOAIHANG NVARCHAR(50) NOT NULL
)
-- S? d?ng câu l?nh SELECT
-- 2.1 Cho bi?t danh sách các d?i tác cung c?p hàng cho công ty.
SELECT macongty,tencongty,tengiaodich
FROM nhacungcap

-- 2. 2 Mã hàng, tên hàng và s? lu?ng c?a các m?t hàng hi?n có trong công ty
SELECT MAHANG, TENHANG, SOLUONG
FROM MATHANG

-- 2. 3 H? tên và d?a ch? và nam b?t d?u làm vi?c c?a các nhân viên
SELECT CONCAT( HO,' ' ,TEN) AS HOVATEN, DIACHI, YEAR(NGAYLAMVIEC) AS YEAR
FROM NHANVIEN

-- 2. 4 Ð?a ch? và di?n tho?i c?a nhà cung c?p có tên giao d?ch VINAMILK là gì?
SELECT TENCONGTY, TENGIAODICH, DIACHI, DIENTHOAI 
FROM NHACUNGCAP

-- 2. 5 Cho bi?t mã và tên c?a các m?t hàng có giá l?n hon 100000 và s? lu?ng hi?n ít hon 50.
SELECT MAHANG, TENHANG
FROM MATHANG
WHERE GIAHANG > 100000 AND
	SOLUONG < 50

-- 2. 6 Cho bi?t m?i m?t hàng trong công ty do ai cung c?p.
SELECT MAHANG, NHACUNGCAP.MACONGTY
FROM NHACUNGCAP, MATHANG
WHERE NHACUNGCAP.MACONGTY = MATHANG.MACONGTY

-- 2. 7 Công ty Vi?t Ti?n dã cung c?p nh?ng m?t hàng nào?
SELECT NHACUNGCAP.MACONGTY, TENCONGTY, TENHANG
FROM NHACUNGCAP, MATHANG
WHERE NHACUNGCAP.MACONGTY = MATHANG.MACONGTY
AND TENCONGTY ='Công ty Vi?t Ti?n'


-- 2. 8 Lo?i hàng th?c ph?m do nh?ng công ty nào cung c?p và d?a ch? c?a các công ty dó là gì?
SELECT TENLOAIHANG, LOAIHANG.MALOAIHANG, MATHANG.MACONGTY, TENCONGTY, DIACHI			
FROM NHACUNGCAP, MATHANG, LOAIHANG
WHERE TENLOAIHANG = 'th?c ph?m' AND
	MATHANG.MALOAIHANG = LOAIHANG.MALOAIHANG AND
	MATHANG.MACONGTY = NHACUNGCAP.MACONGTY

--2. 9 Nh?ng khách hàng nào (tên giao d?ch) dã d?t mua m?t hàng S?a h?p XYZ c?a công ty?
SELECT KHACHHANG.MAKHACHHANG, TENGIAODICH, DONDATHANG.SOHOADON, CHITIETDATHANG.MAHANG, TENHANG
FROM KHACHHANG, DONDATHANG, CHITIETDATHANG, MATHANG
WHERE TENHANG ='S?a h?p XYZ' 
AND MATHANG.MAHANG = CHITIETDATHANG.MAHANG
AND CHITIETDATHANG.SOHOADON = DONDATHANG.SOHOADON
AND DONDATHANG.MAKHACHHANG = KHACHHANG.MAKHACHHANG
	


-- 2. 10 Ðon d?t hàng s? 1 do ai d?t và do nhân viên nào l?p, th?i gian và d?a di?m giao 
SELECT TOP 1 SOHOADON, concat(HO, ' ', TEN) AS HOVATEN, NGAYGIAOHANG, NOIGIAOHANG
FROM DONDATHANG, NHANVIEN
WHERE DONDATHANG.MANHANVIEN = NHANVIEN.MANHANVIEN


-- 2. 11 Hãy cho bi?t s? ti?n luong mà công ty ph?i tr? cho m?i nhân viên là bao nhiêu (luong = luong co b?n + ph? c?p).
SELECT MANHANVIEN, (LUONGCOBAN + PHUCAP) AS LUONG 
FROM NHANVIEN

-- 2. 12 Trong don d?t hàng s? 3 d?t mua nh?ng m?t hàng nào và s? ti?n mà khách hàng ph?i tr? cho m?i m?t hàng là bao nhiêu (s? ti?n ph?i tr? du?c tính theo công th?c SOLUONG?GIABAN – SOLUONG?GIABAN?MUCGIAMGIA/100)
SELECT TENHANG, (a.SOLUONG*GIABAN - a.SOLUONG*GIABAN*MUCGIAMGIA/100) AS SOTIEN
FROM CHITIETDATHANG a
JOIN MATHANG b
ON  a.MAHANG = b.MAHANG
WHERE SOHOADON = 3

 
-- 2. 13 Hãy cho bi?t có nh?ng khách hàng nào l?i chính là d?i tác cung c?p hàng c?a công ty (t?c là có cùng tên giao d?ch).
SELECT DISTINCT NHACUNGCAP.TENCONGTY
FROM KHACHHANG, NHACUNGCAP
WHERE KHACHHANG.TENCONGTY = NHACUNGCAP.TENCONGTY


-- 2. 14 Trong công ty có nh?ng nhân viên nào có cùng ngày sinh?
SELECT A.MANHANVIEN, B.MANHANVIEN, A.NGAYSINH
FROM NHANVIEN A
JOIN NHANVIEN B
ON A.NGAYSINH = B.NGAYSINH
WHERE A.MANHANVIEN <> B.MANHANVIEN

 
-- 2. 15 Nh?ng don d?t hàng nào yêu c?u giao hàng ngay t?i công ty d?t hàng và nh?ng don dó là c?a công ty nào?
SELECT SOHOADON, TENCONGTY
FROM DONDATHANG A
JOIN KHACHHANG B
ON NOIGIAOHANG = DIACHI



-- 2. 16 Cho bi?t tên công ty, tên giao d?ch, d?a ch? và di?n tho?i c?a các khách hàng và các nhà cung c?p hàng cho công ty.
SELECT TENCONGTY, TENGIAODICH, DIACHI, DIENTHOAI FROM KHACHHANG
UNION ALL
SELECT TENCONGTY, TENGIAODICH, DIACHI, DIENTHOAI FROM NHACUNGCAP

-- 2. 17 Nh?ng m?t hàng nào chua t?ng du?c khách hàng d?t mua?
SELECT MAHANG
FROM MATHANG
WHERE MAHANG <> (SELECT DISTINCT MAHANG
FROM CHITIETDATHANG)

-- 2. 18 Nh?ng nhân viên nào c?a công ty chua t?ng l?p b?t k? m?t hoá don d?t hàng nào?
SELECT MANHANVIEN
FROM NHANVIEN
WHERE MANHANVIEN <> (SELECT DISTINCT MANHANVIEN
FROM DONDATHANG)

-- 2. 19 Nh?ng nhân viên nào c?a công ty có luong co b?n cao nh?t?
SELECT TOP 1 MANHANVIEN
FROM NHANVIEN
ORDER BY LUONGCOBAN DESC

--2. 20 T?ng s? ti?n mà khách hàng ph?i tr? cho m?i don d?t hàng là bao nhiêu?
SELECT DISTINCT SOHOADON, SUM((SOLUONG*GIABAN - SOLUONG*GIABAN*MUCGIAMGIA/100)) AS TONGTIEN
FROM CHITIETDATHANG
GROUP BY SOHOADON

-- 2. 21 Trong nam 2003, nh?ng m?t hàng nào ch? du?c d?t mua dúng m?t l?n.
SELECT MAHAN
FROM CHITIETDATHANG A
JOIN DONDATHANG B
on A.SOHOADON = B.SOHOADON
WHERE YEAR (NGAYDATHANG) = 2003
AND COUNT(B.MAHANG) = 1

-- 2. 22 Hãy cho bi?t m?i m?t khách hàng dã ph?i b? ra bao nhiêu ti?n d? d?t mua hàng c?a công ty?
SELECT DISTINCT MAKHACHHANG, SUM((SOLUONG*GIABAN - SOLUONG*GIABAN*MUCGIAMGIA/100)) AS TONGTIEN
FROM CHITIETDATHANG A
JOIN DONDATHANG B
ON A.SOHOADON = B.SOHOADON
GROUP BY MAKHACHHANG

-- 2. 23 M?i m?t nhân viên c?a công ty dã l?p bao nhiêu don d?t hàng (n?u nhân viên chua h? l?p m?t hoá don nào thì cho k?t qu? là 0)
SELECT DISTINCT MANHANVIEN, 
	CASE COUNT(SOHOADON)
		WHEN null THEN 0
		ELSE COUNT(SOHOADON)
	END AS SOLUONGHOADON
FROM DONDATHANG
GROUP BY MANHANVIEN 


--2. 24 Cho bi?t t?ng s? ti?n hàng mà c?a hàng thu du?c trong m?i tháng c?a nam 2003 (th?i du?c gian tính theo ngày d?t hàng).
SELECT DISTINCT MONTH(NGAYDATHANG) AS THANG, SUM((SOLUONG*GIABAN - SOLUONG*GIABAN*MUCGIAMGIA/100)) AS TONGTIEN
FROM DONDATHANG A
JOIN CHITIETDATHANG B
ON A.SOHOADON = B.SOHOADON
WHERE YEAR(NGAYDATHANG) = 2003
GROUP BY MONTH(NGAYDATHANG)
ORDER BY MONTH(NGAYDATHANG)

-- 2. 25 Hãy cho bi?t t?ng s? ti?n l?i mà công ty thu du?c t? m?i m?t hàng trong nam 2003.
-- GIA BAN - GIAHANG = LOI NHUAN
SELECT A.MAHANG, TENHANG, SUM((A.SOLUONG*GIABAN - A.SOLUONG*GIABAN*MUCGIAMGIA/100))  - SUM(GIAHANG) AS LOINHUAN
FROM CHITIETDATHANG A
JOIN MATHANG B
ON A.MAHANG = B.MAHANG
GROUP BY A.MAHANG, TENHANG

-- 2. 26 Hãy cho bi?t t?ng s? lu?ng hàng c?a m?i m?t hàng mà công ty dã có (t?ng s? lu?ng hàng hi?n có và dã bán).
SELECT MAHANG, SOLUONG FROM CHITIETDATHANG
UNION
SELECT MAHANG, SOLUONG FROM CHITIETDATHANG
GROUP BY 
ORDER BY

-- 2. 27 Nhân viên nào c?a công ty bán du?c s? lu?ng hàng nhi?u nh?t và s? lu?ng hàng bán du?c c?a nh?ng nhân viên này là bao nhiêu?
SELECT TOP 1 MANHANVIEN, SUM(SOLUONG) AS TONGSOLUONG
FROM CHITIETDATHANG A
JOIN DONDATHANG B
ON A.SOHOADON = B.SOHOADON
GROUP BY MANHANVIEN
ORDER BY TONGSOLUONG



2. 28 Ðon d?t hàng nào có s? lu?ng hàng du?c d?t mua ít nh?t?
SELECT TOP 1 SOHOADON
FROM CHITIETDATHANG
GROUP BY SOHOADON 
ORDER BY SUM(SOLUONG) 


-- 2. 29 S? ti?n nhi?u nh?t mà m?i khách hàng dã t?ng b? ra d? d?t hàng trong các don d?t hàng là bao nhiêu?
SELECT DISTINCT MAKHACHHANG, MAX( SUM((SOLUONG*GIABAN - SOLUONG*GIABAN*MUCGIAMGIA/100)))
FROM CHITIETDATHANG A
JOIN DONDATHANG B
ON A.SOHOADON = B.SOHOADON
GROUP BY MAKHACHHANG


2. 30 M?i m?t don d?t hàng d?t mua nh?ng m?t hàng nào và t?ng s? ti?n mà m?i don d?t hàng ph?i tr? là bao nhiêu?

-- LIST RA AF?????


2. 31 Hãy cho bi?t m?i m?t lo?i hàng bao g?m nh?ng m?t hàng nào, t?ng s? lu?ng hàng c?a m?i lo?i và t?ng s? lu?ng c?a t?t c? các m?t hàng hi?n có trong công ty là bao nhiêu?
SELECT DISTINCT MAHANG, TENHANG, MALOAIHANG, SOLUONG AS TONGSOLUONG, (A.SOLUONG - SUM(B.SOLUONG))
FROM 


2. 32 Th?ng kê xem trong nam 2003, m?i m?t m?t hàng trong m?i tháng và trong c? nam bán du?c v?i s? lu?ng bao nhiêu
Yêu c?u: K?t qu? du?c hi?n th? du?i d?ng b?ng, hai c?t c?t d?u là mã hàng và tên hàng, các c?t còn l?i tuong ?ng v?i các tháng t? 1 d?n 12 và c? nam. Nhu v?y m?i dòng trong k?t qu? cho bi?t s? lu?ng hàng bán du?c m?i tháng và trong c? nam c?a m?i m?t hàng.
SELECT 
A.MAHANG, 
B.TENHANG,
SUM(CASE MONTH(NGAYDATHANG) WHEN 1 THEN A.SOLUONG ELSE 0 END)  AS Thang1,
SUM(CASE MONTH(NGAYDATHANG) WHEN 2 THEN A.SOLUONG ELSE 0 END)  AS Thang2,
SUM(CASE MONTH(NGAYDATHANG) WHEN 3 THEN A.SOLUONG ELSE 0 END)  AS Thang3,
SUM(CASE MONTH(NGAYDATHANG) WHEN 4 THEN A.SOLUONG ELSE 0 END)  AS Thang4,
SUM(CASE MONTH(NGAYDATHANG) WHEN 5 THEN A.SOLUONG ELSE 0 END)  AS Thang5,
SUM(CASE MONTH(NGAYDATHANG) WHEN 6 THEN A.SOLUONG ELSE 0 END)  AS Thang6,
SUM(CASE MONTH(NGAYDATHANG) WHEN 7 THEN A.SOLUONG ELSE 0 END)  AS Thang7,
SUM(CASE MONTH(NGAYDATHANG) WHEN 8 THEN A.SOLUONG ELSE 0 END)  AS Thang8,
SUM(CASE MONTH(NGAYDATHANG) WHEN 9 THEN A.SOLUONG ELSE 0 END)  AS Thang9,
SUM(CASE MONTH(NGAYDATHANG) WHEN 10 THEN A.SOLUONG ELSE 0 END)  AS Thang10,
SUM(CASE MONTH(NGAYDATHANG) WHEN 11 THEN A.SOLUONG ELSE 0 END)  AS Thang11,
SUM(CASE MONTH(NGAYDATHANG) WHEN 12 THEN A.SOLUONG ELSE 0 END)  AS Thang12,
SUM(A.SOLUONG)   AS Ca_nam
FROM CHITIETDATHANG A
JOIN MATHANG B
ON A.MAHANG = B.MAHANG
JOIN DONDATHANG C
ON A.SOHOADON = C.SOHOADON 
WHERE YEAR(NGAYDATHANG) = 2003
GROUP BY A.MAHANG, B.TENHANG


/* Sử dụng câu lệnh UPDATE để thực hiện các yêu cầu sau:
 
 */
2. 33 Cập nhật lại giá trị trường NGAYCHUYENHANG của những bản ghi có NGAYCHUYENHANG chưa xác định (NULL) trong bảng DONDATHANG bằng với giá trị của trường NGAYDATHANG.
UPDATE DONDATHANG
SET NGAYCHUYENHANG = NGAYDATHANG
WHERE NGAYCHUYENHANG IS NULL 


2. 34 Tăng số lượng hàng của những mặt hàng do công ty VINAMILK cung cấp lên gấp đôi.
UPDATE MATHANG
SET SOLUONG = SOLUONG*2 
FROM NHACUNGCAP
WHERE MATHANG.MACONGTY = NHACUNGCAP.MACONGTY
AND TENCONGTY = 'VINAMILK'
 
2. 35 Cập nhật giá trị của trường NOIGIAOHANG trong bảng DONDATHANG bằng địa chỉ của khách hàng đối với những đơn đặt hàng chưa xác định được nơi giao hàng (giá trị trường NOIGIAOHANG bằng NULL).
UPDATE DONDATHANG
SET NOIGIAOHANG = DIACHI
FROM KHACHHANG
WHERE DONDATHANG.MAKHACHHANG = KHACHHANG.MAKHACHHANG

2. 36 Cập nhật lại dữ liệu trong bảng KHACHHANG sao cho nếu tên công ty và tên giao dịch của khách hàng trùng với tên công ty và tên giao dịch của một nhà cung cấp nào đó thì địa chỉ, điện thoại, fax và e-mail phải giống nhau.
UPDATE KHACHHANG
SET KHACHHANG.DIACHI = NHACUNGCAP.DIACHI,
	KHACHHANG.EMAIL = NHACUNGCAP.EMAIL,
	KHACHHANG.DIENTHOAI = NHACUNGCAP.DIENTHOAI,
	KHACHHANG.FAX = NHACUNGCAP.FAX
FROM NHACUNGCAP 
WHERE KHACHHANG.TENCONGTY = NHACUNGCAP.TENCONGTY
AND	KHACHHANG.TENGIAODICH = NHACUNGCAP.TENGIAODICH

2. 37 Tăng lương lên gấp rưỡi cho những nhân viên bán được số lượng hàng nhiều hơn 100 trong năm 2003.
UPDATE NHANVIEN
SET LUONGCOBAN = LUONGCOBAN*1.5
WHERE MANHANVIEN = 
( SELECT MANHANVIEN
FROM CHITIETDATHANG A
JOIN DONDATHANG B
ON A.SOHOADON = B.SOHOADON
WHERE YEAR(NGAYDATHANG) = 2003
GROUP BY MANHANVIEN
HAVING SUM(SOLUONG) > 100)


2. 38 Tăng phụ cấp lên bằng 50% lương cho những nhân viên bán được hàng nhiều nhất.
UPDATE NHANVIEN
SET PHUCAP = PHUCAP*1.5
WHERE MANHANVIEN = 
( SELECT TOP 10 MANHANVIEN
FROM CHITIETDATHANG A
JOIN DONDATHANG B
ON A.SOHOADON = B.SOHOADON
GROUP BY MANHANVIEN
ORDER BY SUM(SOLUONG) DESC)

2. 39 Giảm 25% lương của những nhân viên trong năm 2003 không lập được bất kỳ đơn đặt hàng nào.
UPDATE NHANVIEN
SET LUONGCOBAN = LUONGCOBAN*0.75
WHERE MANHANVIEN =
( SELECT MANHANVIEN
FROM DONDATHANG 
GROUP BY MANHANVIEN
HAVING COUNT(SOHOADON) < 1)

2. 40 Giả sử trong bảng DONDATHANG có thêm trường SOTIEN cho biết số tiền mà khách hàng phải trả trong mỗi đơn đặt hàng. Hãy tính giá trị cho trường này.
ALTER TABLE DONDATHANG
ADD SOTIEN 
UPDATE DONDATHANG
SET SOTIEN = (SOLUONG*GIABAN - SOLUONG*GIABAN*MUCGIAMGIA/100)


-- Thực hiện các yêu cầu dưới đây bằng câu lệnh DELETE.
 
2. 41 Xoá khỏi bảng NHANVIEN những nhân viên đã làm việc trong công ty quá 40 năm.
DELETE FROM NHANVIEN
WHERE DATEDIFF(YEAR, GETDATE(), NGAYLAMVIEN) > 40

2. 42 Xoá những đơn đặt hàng trước năm 2000 ra khỏi cơ sở dữ liệu.
DELETE FROM DONDATHANG
WHERE YEAR(NGAYDATHANG) < 2000

2. 43 Xoá khỏi bảng LOAIHANG những loại hàng hiện không có mặt hàng.
DELETE FROM LOAIHANG
FROM MATHANG
WHERE  LOAIHANG.MALOAIHANG =  MATHANG.MALOAIHANG
AND SOLUONG <1

2. 44 Xoá khỏi bảng KHACHHANG những khách hàng hiện không có bất kỳ đơn đặt hàng nào cho công ty.
DELETE FROM KHACHHANG
WHERE MAKHACHHANG =
(SELECT MAKHACHHANG 
FROM DONDATHANG
GROUP BY MAKHACHHANG 
HAVING COUNT(SOHOADON) < 1)

2.	45 Xoá khỏi bảng MATHANG những mặt hàng có số lượng bằng 0 và không được đặt mua trong bất kỳ đơn đặt hàng nào.
DELETE FROM MATHANG
WHERE SOLUONG = 0 AND
MAHANG = (SELECT MAHANG FROM CHITIETDATHANG
GROUP BY MAHANG
HAVING COUNT(SOHOADON) < 1)
